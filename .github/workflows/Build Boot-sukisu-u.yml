name: Build Boot Image (AOSP Clang Latest + SukiSU Option)  # æ˜ç¡®â€œæœ€æ–°ç‰ˆâ€

# ä»…æ‰‹åŠ¨è§¦å‘
on:
  workflow_dispatch:
    inputs:
      kernel_branch:
        description: 'å†…æ ¸æºç åˆ†æ”¯'
        required: true
        default: 'lineage-22.2'
        type: string
      device_codename:
        description: 'è®¾å¤‡ä»£å·ï¼ˆå¦‚ pdx234ï¼‰'
        required: true
        default: 'pdx234'
        type: string
      build_type:
        description: 'ç¼–è¯‘ç±»å‹'
        required: true
        default: 'original'
        type: choice
        options:
          - original  # åŸå†…æ ¸ï¼ˆæ—  SukiSUï¼‰
          - with_sukisu  # å¸¦ SukiSU å†…æ ¸

jobs:
  # --------------------------
  # Job 1ï¼šä¾èµ–å‡†å¤‡ä¸ç¼“å­˜ï¼ˆæœ€æ–° AOSP Clang + SukiSUï¼‰
  # --------------------------
  prepare-dependencies:
    runs-on: ubuntu-22.04
    outputs:
      device_codename: ${{ github.event.inputs.device_codename || 'pdx234' }}
      kernel_branch: ${{ github.event.inputs.kernel_branch || 'lineage-22.2' }}
      build_type: ${{ github.event.inputs.build_type || 'original' }}
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4

      - name: Install download dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git git-lfs wget curl lz4 patch unzip

      # 1. ç¼“å­˜å†…æ ¸æºç ï¼ˆä¿æŒä¸å˜ï¼‰
      - name: Cache kernel source
        id: cache-kernel
        uses: actions/cache@v3
        with:
          path: ./kernel
          key: kernel-${{ github.event.inputs.kernel_branch }}-${{ github.event.inputs.device_codename }}-${{ github.event.inputs.build_type }}-${{ runner.os }}
          restore-keys: |
            kernel-${{ github.event.inputs.kernel_branch }}-${{ github.event.inputs.device_codename }}-${{ github.event.inputs.build_type }}-

      - name: Clone kernel source (if not cached)
        if: steps.cache-kernel.outputs.cache-hit != 'true'
        run: |
          KERNEL_REPO="https://github.com/LineageOS/android_kernel_sony_sm8550.git"
          KERNEL_BRANCH="${{ github.event.inputs.kernel_branch || 'lineage-22.2' }}"
          git clone $KERNEL_REPO kernel
          cd kernel && git checkout $KERNEL_BRANCH && git rev-parse HEAD > ../kernel_commit.txt

      # 2. é›†æˆ SukiSUï¼ˆä¿æŒä¸å˜ï¼‰
      - name: Integrate SukiSU (if build type is with_sukisu)
        if: github.event.inputs.build_type == 'with_sukisu'
        run: |
          cd kernel
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s main
          
          if [ -f ./include/config/sukisu.h ]; then
            SUKISU_VERSION=$(grep "SUKISU_VERSION" ./include/config/sukisu.h | cut -d '"' -f2)
          elif [ -f ./include/config/kernelsu.h ]; then
            SUKISU_VERSION=$(grep "KSU_VERSION" ./include/config/kernelsu.h | cut -d '"' -f2)
          else
            SUKISU_VERSION="unknown"
          fi
          echo "SUKISU_VERSION=$SUKISU_VERSION" >> $GITHUB_ENV

      # 3. ç¼“å­˜è®¾å¤‡æ ‘ï¼ˆä¿æŒä¸å˜ï¼‰
      - name: Cache device trees
        id: cache-device
        uses: actions/cache@v3
        with:
          path: |
            ./device/sony/${{ github.event.inputs.device_codename || 'pdx234' }}
            ./device/sony/sm8550-common
          key: device-${{ github.event.inputs.device_codename }}-${{ github.event.inputs.kernel_branch }}-${{ runner.os }}
          restore-keys: |
            device-${{ github.event.inputs.device_codename }}-

      - name: Clone device trees (if not cached)
        if: steps.cache-device.outputs.cache-hit != 'true'
        run: |
          DEVICE_CODENAME="${{ github.event.inputs.device_codename || 'pdx234' }}"
          KERNEL_BRANCH="${{ github.event.inputs.kernel_branch || 'lineage-22.2' }}"
          mkdir -p device/sony
          git clone https://github.com/LineageOS/android_device_sony_${DEVICE_CODENAME}.git device/sony/${DEVICE_CODENAME}
          git clone https://github.com/LineageOS/android_device_sony_sm8550-common.git device/sony/sm8550-common
          cd device/sony/${DEVICE_CODENAME} && git checkout $KERNEL_BRANCH && cd ../../..
          cd device/sony/sm8550-common && git checkout $KERNEL_BRANCH && cd ../../..

      # 4. ç¼“å­˜ AOSP æœ€æ–°ç‰ˆ Clangï¼ˆæ›¿æ¢å›ºå®šç‰ˆæœ¬ï¼‰
      - name: Cache AOSP Prebuilt Clang (Latest)
        id: cache-aosp-clang
        uses: actions/cache@v3
        with:
          # ç»Ÿä¸€ä½¿ç”¨ "clang-latest" ç›®å½•ï¼Œé¿å…ç‰ˆæœ¬å·ç¡¬ç¼–ç 
          path: ./prebuilts/clang/host/linux-x86/clang-latest
          # ç¼“å­˜ key ä¸å«ç‰ˆæœ¬å·ï¼Œç¡®ä¿æ¯æ¬¡è·å–æœ€æ–°
          key: aosp-clang-latest-${{ runner.os }}
          restore-keys: |
            aosp-clang-latest-

      # 5. å…‹éš† AOSP æœ€æ–°ç‰ˆ Clangï¼ˆè‹¥æœªç¼“å­˜ï¼‰
      - name: Clone AOSP Prebuilt Clang (Latest) if not cached
        if: steps.cache-aosp-clang.outputs.cache-hit != 'true'
        run: |
          # åˆ›å»ºåŸºç¡€ç›®å½•
          mkdir -p prebuilts/clang/host/linux-x86
          
          # æµ…å…‹éš† AOSP é¢„ç¼–è¯‘ Clang ä»“åº“ï¼ˆä»…æœ€æ–°æäº¤ï¼Œä½“ç§¯å°ï¼‰
          git clone --depth=1 https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/ prebuilts/clang/host/linux-x86/temp_clone
          
          # æŸ¥æ‰¾æœ€æ–°çš„ clang-r<æ•°å­—> ç›®å½•ï¼ˆæŒ‰ç‰ˆæœ¬å·æ’åºï¼Œå–æœ€åä¸€ä¸ªï¼‰
          # æ ¼å¼ç¤ºä¾‹ï¼šclang-r547379ã€clang-r550300ï¼Œsort -V æŒ‰ç‰ˆæœ¬å·å‡åºæ’åˆ—
          LATEST_CLANG_DIR=$(ls -1d prebuilts/clang/host/linux-x86/temp_clone/clang-r* | sort -V | tail -n1)
          
          # é‡å‘½åä¸º "clang-latest"ï¼Œä¾¿äºåç»­ç»Ÿä¸€å¼•ç”¨
          mv $LATEST_CLANG_DIR prebuilts/clang/host/linux-x86/clang-latest
          
          # åˆ é™¤ä¸´æ—¶å…‹éš†ç›®å½•ï¼ˆä»…ä¿ç•™æœ€æ–°ç‰ˆï¼ŒèŠ‚çœç©ºé—´ï¼‰
          rm -rf prebuilts/clang/host/linux-x86/temp_clone
          
          # éªŒè¯ï¼šæ£€æŸ¥ Clang å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          echo "âœ… æœ€æ–° Clang ç›®å½•ï¼š$LATEST_CLANG_DIR"
          if [ -f "prebuilts/clang/host/linux-x86/clang-latest/bin/clang" ]; then
            echo "âœ… Clang å·¥å…·é“¾è·å–æˆåŠŸï¼ç‰ˆæœ¬ä¿¡æ¯ï¼š"
            prebuilts/clang/host/linux-x86/clang-latest/bin/clang --version
          else
            echo "âŒ Clang å·¥å…·é“¾ç¼ºå¤±ï¼"
            exit 1  # ç»ˆæ­¢å·¥ä½œæµï¼Œæç¤ºé”™è¯¯
          fi

  # --------------------------
  # Job 2ï¼šç”¨ AOSP æœ€æ–° Clang ç¼–è¯‘å†…æ ¸ä¸ç”Ÿæˆ boot.img
  # --------------------------
  compile-bootimg:
    runs-on: ubuntu-22.04
    needs: prepare-dependencies
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4

      - name: Install AOSP Clang build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison build-essential ccache flex g++-multilib gcc-multilib lib32ncurses5-dev lib32readline-dev lib32z1-dev libelf-dev liblz4-tool libncurses5-dev libssl-dev lzop rsync zip zlib1g-dev
          sudo apt-get install -y binutils-aarch64-linux-gnu

      # æ¢å¤ç¼“å­˜ï¼ˆå†…æ ¸ã€è®¾å¤‡æ ‘ä¿æŒä¸å˜ï¼ŒClang æ¢å¤æœ€æ–°ç‰ˆï¼‰
      - name: Restore kernel source cache
        uses: actions/cache@v3
        with:
          path: ./kernel
          key: kernel-${{ needs.prepare-dependencies.outputs.kernel_branch }}-${{ needs.prepare-dependencies.outputs.device_codename }}-${{ needs.prepare-dependencies.outputs.build_type }}-${{ runner.os }}

      - name: Restore device trees cache
        uses: actions/cache@v3
        with:
          path: |
            ./device/sony/${{ needs.prepare-dependencies.outputs.device_codename }}
            ./device/sony/sm8550-common
          key: device-${{ needs.prepare-dependencies.outputs.device_codename }}-${{ needs.prepare-dependencies.outputs.kernel_branch }}-${{ runner.os }}

      - name: Restore AOSP Prebuilt Clang (Latest)
        uses: actions/cache@v3
        with:
          path: ./prebuilts/clang/host/linux-x86/clang-latest
          key: aosp-clang-latest-${{ runner.os }}

      - name: Configure AOSP Clang Path (Latest)
        run: |
          # å·¥å…·é“¾ç»å¯¹è·¯å¾„
          AOSP_CLANG_BIN=$(pwd)/prebuilts/clang/host/linux-x86/clang-latest/bin
    
          # å¼ºåˆ¶å°† AOSP Clang è·¯å¾„æ”¾åœ¨ PATH æœ€å‰é¢ï¼Œè¦†ç›–ç³»ç»Ÿé»˜è®¤
          echo "PATH=$AOSP_CLANG_BIN:$PATH" >> $GITHUB_ENV
    
          # éªŒè¯è·¯å¾„æ˜¯å¦æ­£ç¡®ï¼ˆå…³é”®è°ƒè¯•æ­¥éª¤ï¼‰
          echo "AOSP Clang è·¯å¾„: $AOSP_CLANG_BIN"
          echo "å½“å‰ PATH: $PATH"
    
          # éªŒè¯ AOSP Clang æ˜¯å¦è¢«æ­£ç¡®è¯†åˆ«
          echo "ğŸ” éªŒè¯ AOSP Clang ç‰ˆæœ¬ï¼š"
          $AOSP_CLANG_BIN/clang --version  # ç›´æ¥ç”¨ç»å¯¹è·¯å¾„éªŒè¯
    
          # éªŒè¯ ld.lld æ˜¯å¦å­˜åœ¨
          echo "ğŸ” éªŒè¯ ld.lld æ˜¯å¦å­˜åœ¨ï¼š"
          if [ -f "$AOSP_CLANG_BIN/ld.lld" ]; then
            echo "âœ… ld.lld è·¯å¾„ï¼š$AOSP_CLANG_BIN/ld.lld"
            $AOSP_CLANG_BIN/ld.lld --version
          else
            echo "âŒ AOSP Clang å·¥å…·é“¾ä¸­æœªæ‰¾åˆ° ld.lldï¼"
            exit 1
          fi

      # ç”¨ AOSP æœ€æ–° Clang ç¼–è¯‘å†…æ ¸ï¼ˆå·¥å…·é“¾å‘½åé€‚é…ï¼‰
      - name: Build kernel with AOSP Clang (Latest)
        run: |
          cd kernel
          # åŸºç¡€æ¶æ„é…ç½®
          export ARCH=arm64
          # AOSP Clang æ ‡å‡†å·¥å…·é“¾å‘½åï¼ˆæ— ç‰ˆæœ¬åç¼€ï¼Œè‡ªåŠ¨åŒ¹é… latest ç›®å½•ï¼‰
          export CC=aarch64-linux-android-clang
          export CXX=aarch64-linux-android-clang++
          export LD=ld.lld
          export AR=llvm-ar
          export NM=llvm-nm
          export OBJCOPY=llvm-objcopy
          export OBJDUMP=llvm-objdump
          export STRIP=llvm-strip
          # æ¸…é™¤å¹²æ‰°å˜é‡ï¼ˆé¿å…å†²çªï¼‰
          unset GCC CCACHE_COMPILER

          # åŠ è½½è®¾å¤‡ä¸“å± defconfigï¼ˆéœ€å†…æ ¸æºç å­˜åœ¨ <è®¾å¤‡ä»£å·>_defconfigï¼‰
          echo "ğŸ“ åŠ è½½ defconfigï¼š${{ needs.prepare-dependencies.outputs.device_codename }}_defconfig"
          make O=out defconfig ${needs.prepare-dependencies.outputs.device_codename}_defconfig
          
          # å¯ç”¨ SukiSU é…ç½®ï¼ˆä¿æŒä¸å˜ï¼‰
          if [ "${{ needs.prepare-dependencies.outputs.build_type }}" = "with_sukisu" ]; then
            echo "ğŸ”§ å¯ç”¨ SukiSU é…ç½®"
            make O=out menuconfig KCONFIG_CONFIG=out/.config -e CONFIG_KERNEL_SU=y CONFIG_KERNEL_SU_MODULES=y
          fi
          
          # å¤šæ ¸ç¼–è¯‘ï¼ˆåˆ©ç”¨ GitHub Actions å…¨éƒ¨æ ¸å¿ƒï¼‰
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘å†…æ ¸ï¼Œçº¿ç¨‹æ•°ï¼š$(nproc)"
          make O=out -j$(nproc)

      # ç”Ÿæˆ ramdiskï¼ˆä¿æŒä¸å˜ï¼‰
      - name: Prepare ramdisk
        run: |
          DEVICE_CODENAME="${{ needs.prepare-dependencies.outputs.device_codename }}"
          mkdir -p ramdisk
          cp -r device/sony/${DEVICE_CODENAME}/ramdisk/* ramdisk/
          cd ramdisk && find . | cpio -o -H newc | lz4 -l -12 -f - ../ramdisk.img && cd ..
          echo "âœ… ramdisk.img ç”Ÿæˆå®Œæˆ"

      # æ‰“åŒ… boot.imgï¼ˆäº§ç‰©åç§°å«â€œlatest-clangâ€æ ‡è¯†ï¼‰
      - name: Build boot.img
        run: |
          DEVICE_CODENAME="${{ needs.prepare-dependencies.outputs.device_codename }}"
          KERNEL_BRANCH="${{ needs.prepare-dependencies.outputs.kernel_branch }}"
          BUILD_TYPE="${{ needs.prepare-dependencies.outputs.build_type }}"
          
          # ä¸‹è½½æœ€æ–°ç‰ˆ mkbootimg å·¥å…·
          wget https://github.com/osm0sis/mkbootimg/releases/latest/download/mkbootimg -O mkbootimg
          chmod +x mkbootimg
          
          # äº§ç‰©åç§°ï¼šæ·»åŠ â€œlatest-clangâ€æ ‡è¯†ï¼ŒåŒºåˆ†å›ºå®šç‰ˆæœ¬
          if [ "$BUILD_TYPE" = "with_sukisu" ]; then
            OUTPUT_NAME="boot-${DEVICE_CODENAME}-${KERNEL_BRANCH}-aosp-latest-clang-sukisu-v${{ env.SUKISU_VERSION }}.img"
          else
            OUTPUT_NAME="boot-${DEVICE_CODENAME}-${KERNEL_BRANCH}-aosp-latest-clang-original.img"
          fi
          
          # æ‰“åŒ… boot.imgï¼ˆå‚æ•°ä¿æŒåŸé…ç½®ï¼‰
          ./mkbootimg \
            --kernel kernel/out/arch/arm64/boot/Image.gz-dtb \
            --ramdisk ramdisk.img \
            --base 0x00000000 \
            --cmdline "video=vfb:640x400,bpp=32,memsize=3072000 nosoftlockup" \
            --bootconfig "androidboot.hardware=qcom androidboot.memcg=1 androidboot.usbcontroller=a600000.dwc3" \
            --pagesize 4096 \
            --ramdiskoffset 0x01000000 \
            --tagsoffset 0x00000100 \
            --headerversion 4 \
            --osversion 14 \
            --ospatchlevel 2025-04 \
            --output $OUTPUT_NAME
          
          echo "âœ… boot.img ç”Ÿæˆå®Œæˆï¼š$OUTPUT_NAME"
          ls -lh $OUTPUT_NAME  # æ˜¾ç¤ºäº§ç‰©å¤§å°ï¼ŒéªŒè¯æ˜¯å¦ç”Ÿæˆ

      # ä¸Šä¼ äº§ç‰©ï¼ˆåç§°å«â€œlatest-clangâ€ï¼‰
      - name: Upload boot.img
        uses: actions/upload-artifact@v4
        with:
          name: boot-image-${{ needs.prepare-dependencies.outputs.device_codename }}-aosp-latest-clang-${{ needs.prepare-dependencies.outputs.build_type }}
          path: boot-${{ needs.prepare-dependencies.outputs.device_codename }}-*.img
